using System;

namespace Sitecore.Support.Hooks
{
  using Sitecore.Configuration;
  using Sitecore.Diagnostics;
  using Sitecore.Events.Hooks;
  using Sitecore.SecurityModel;

  public class FixSelectMediaDialog : IHook
  {
    public void Initialize()
    {
      using (new SecurityDisabler())
      {
        var databaseName = "core";
        var itemPath = "/sitecore/client/Applications/Dialogs/SelectMediaDialog";
        var fieldName = "__Renderings";
        var fieldValue = "<r>  <d id=\"{FE5D7FDF-89C0-4D99-9AA3-B5FBD009C9F3}\" l=\"{4F72A793-BDBC-4262-9523-6AADD8FEA487}\">    <r id=\"{DAFAFFB8-74AF-4141-A96A-70B16834CEC6}\" par=\"PageCodeTypeName=Sitecore.Speak.Applications.SelectMediaDialog%2c+Sitecore.Speak.Applications&amp;PageCodeScriptFileName=%2fsitecore%2fshell%2fclient%2fApplications%2fDialogs%2fSelectMediaDialog.js\" ph=\"Page.Code\" uid=\"{237256AA-9D30-463E-9ED1-90CFF092FCF6}\" />    <r id=\"{7BA20861-BC27-4F0E-94DD-8F974628A5C4}\" ph=\"Page.Body\" uid=\"{50606E5F-8450-418F-B448-859F66371220}\" />    <r id=\"{D47D6BFD-4F1F-4715-9FD1-5957EC0259F5}\" par=\"PageSize=20&amp;FacetsRootItemId=%7b7F43D3D0-CAC6-45D8-96FE-B76F4A117F9B%7d&amp;Id=DataSource&amp;Facets=%7bBinding+FilterControl.SelectedFacets%7d&amp;Text=%7bBinding+SearchTextBox.Text%7d&amp;Database=%24context_contentdatabase&amp;SearchConfigItemId=%7bB0DF45DF-EA31-4C11-9E34-98B41DF549C5%7d&amp;Fields=__Created%7cDimensions&amp;SelectedFacets=%7bBinding+FilterControl.SelectedFacets%7d&amp;Formatting=%24convert_date_to_friendly_format\" ph=\"Page.Body\" uid=\"{B0F7C866-8C4D-43C6-989A-5554DF1EFEA8}\" />    <r id=\"{642C1164-3AE1-4D86-8474-3BC19FE4433B}\" ph=\"DialogHeader\" uid=\"{3AB2380C-C8AD-4B42-8848-69418CE847F8}\" />    <r id=\"{D8C6868D-7AE2-447F-9FD2-E712FDFA46C1}\" ph=\"DialogFooter\" uid=\"{A061A4E7-F47D-42F8-AC31-6D9F0441F9B2}\" />    <r id=\"{300455F0-D5AF-4EB6-8758-BD41875C981C}\" ph=\"DialogContent\" uid=\"{57882B01-67A3-40A2-B6F0-F84287D6F584}\" />    <r id=\"{F6C9F461-FCAF-47DC-AA01-C8C64C2EFFB8}\" par=\"Id=MainBorder\" ph=\"DialogContent.Main\" uid=\"{17882B01-67A3-40A2-B6F0-F84287D6F584}\" />    <r ds=\"{75C88A75-CFC2-4BED-AE82-F19F4A1B7648}\" id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=HeaderTitle\" ph=\"DialogHeader.Title\" uid=\"{1DC97590-77EC-4F75-A687-D86F7D22CAAA}\" />    <r ds=\"{9E8B6F9F-4737-4B7D-AB7F-5BAC6AABC74D}\" id=\"{913AB005-2527-4C2D-9827-FB3A8DFB135C}\" par=\"Id=SelectMediaButton&amp;IsEnabled=0&amp;ButtonType=Primary\" ph=\"DialogFooter.Buttons\" uid=\"{F5005B19-B18B-47BE-B0CA-D92005C2FECA}\" />    <r ds=\"{BEABC7A4-0D0A-4D4C-9220-CF3124FA4DA3}\" id=\"{913AB005-2527-4C2D-9827-FB3A8DFB135C}\" par=\"Id=CancelButton&amp;ButtonType=Default\" ph=\"DialogFooter.Buttons\" uid=\"{F5005B19-B18B-47BE-B0CA-D92005C2FECA}\" />    <r id=\"{EA28ED83-0F59-4BB9-AA95-6FAC9C3385D6}\" par=\"Id=NavigationPanelToggleButton1\" ph=\"DialogHeader.Navigation\" uid=\"{ACF44F30-C335-4171-A3C6-B70FC2908025}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=SelectedMediaTitle&amp;TextType=LargeTitle&amp;Text=%7bBinding+Menu.selectedItemName%7d\" ph=\"DialogContent.Title\" uid=\"{07277A71-CC94-4279-BC89-6C9A07A6CD18}\" />    <r id=\"{C4393722-39FA-4869-9582-3A8EB8983A0D}\" par=\"Id=ToolbarRowPanel\" ph=\"DialogContent.Actions\" uid=\"{51FA5B43-38BA-48FB-A570-0FAB6F63E0D2}\" />    <r id=\"{5CB208F6-1860-426B-8221-FAA85B329848}\" par=\"Id=SearchColumnPanel&amp;ApplyGridColumsToAllSizes=1&amp;GridColumns=8\" ph=\"ToolbarRowPanel.Content\" uid=\"{4FA2CAAB-8AAA-40D0-8084-E5A0494DCC77}\" />    <r ds=\"{0FA74AF6-EF85-42FB-BE65-2CA890D9F2BA}\" id=\"{ED5C3BA8-17E3-4F82-89C2-1496E8D61434}\" par=\"Id=Search\" ph=\"SearchColumnPanel.Content\" uid=\"{8F83EAA5-EA74-4FD1-8DF7-A0C0C1142C1C}\" />    <r ds=\"{5851771D-A078-4ACD-AEF8-4F3D8E0FD440}\" id=\"{E4C8C7BE-E941-49F2-9724-29237AE7EA37}\" par=\"Click=javascript%3aapp.DataSource.refresh()&amp;IsEnabled=1&amp;ButtonImageUrl=%2fsitecore%2fshell%2fclient%2fSpeak%2fAssets%2fimg%2fSpeak%2fCommon%2f16x16%2fdark_gray%2fsearch.png&amp;Id=SearchTextBox&amp;IsVisible=1\" ph=\"Search.Searches\" uid=\"{768822F8-D3D8-405A-81CD-E7EF22A783E4}\" />    <r ds=\"{767E850F-74E4-475B-A139-48FFBEF13454}\" id=\"{26B2B002-BCA0-4968-99E4-01573338B6A9}\" par=\"Click=javascript%3aapp.FilterControl.toggle()&amp;ShowArrow=1&amp;Id=FilterButton&amp;IsEnabled=%7bBinding+DataSource.hasItems%7d&amp;ButtonType=Default\" ph=\"Search.Filters\" uid=\"{B127F507-0C90-4EBC-A4DD-11AA09788349}\" />    <r id=\"{5CB208F6-1860-426B-8221-FAA85B329848}\" par=\"Id=ViewModeColumnPanel&amp;ApplyGridColumsToAllSizes=1&amp;GridColumns=4&amp;ContentAlign=Right\" ph=\"ToolbarRowPanel.Content\" uid=\"{4FA2CAAB-8AAA-40D0-8084-E5A0494DCC77}\" />    <r ds=\"{730B1DA5-E254-451F-BB49-6717679098D5}\" id=\"{26B2B002-BCA0-4968-99E4-01573338B6A9}\" par=\"Id=ListViewToggleButton&amp;IsEnabled=0&amp;IsOpen=1&amp;ImageUrl=%2fsitecore%2fshell%2fclient%2fSpeak%2fAssets%2fimg%2fsc-sprite.png&amp;Dimension=Normal&amp;BackgroundPosition=-153px+-136px\" ph=\"ViewModeColumnPanel.Content\" uid=\"{820468A0-A83B-4F73-ACCD-A91174BB99CD}\" />    <r ds=\"{925DEFF5-865D-48C7-9126-9F5500ADBCC2}\" id=\"{26B2B002-BCA0-4968-99E4-01573338B6A9}\" par=\"Click=javascript%3awindow.location%3d%27%2fsitecore%2fclient%2fApplications%2fDialogs%2fSelectMediaViaTreeDialog%3fro%3d%7b0%7d%26fo%3d%7b1%7d%26showFullPath%3d%7b2%7d%27&amp;Id=TreeViewToggleButton&amp;ImageUrl=%2fsitecore%2fshell%2fclient%2fSpeak%2fAssets%2fimg%2fsc-sprite.png&amp;Dimension=Normal&amp;BackgroundPosition=-390px+-357px\" ph=\"ViewModeColumnPanel.Content\" uid=\"{820468A0-A83B-4F73-ACCD-A91174BB99CD}\" />    <r id=\"{C4393722-39FA-4869-9582-3A8EB8983A0D}\" par=\"Id=MediaFolderRowPanel\" ph=\"MainBorder.Content\" uid=\"{97FF70C2-6455-4EED-A6DF-17D4214B8284}\" />    <r id=\"{5CB208F6-1860-426B-8221-FAA85B329848}\" par=\"Id=MediaFolderColumnPanel&amp;ApplyGridColumsToAllSizes=1&amp;GridColumns=12\" ph=\"MediaFolderRowPanel.Content\" uid=\"{4BB2338D-BD8A-42AC-BCFE-668430C13E76}\" />    <r ds=\"{FE6B8E51-CC00-44E5-A140-EB341487B42E}\" id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=MediaFolderText&amp;TextType=Label\" ph=\"MediaFolderColumnPanel.Content\" uid=\"{786943CB-6E45-4129-906B-93F0E7282831}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=MediaFolderValueText&amp;TextType=Value\" ph=\"MediaFolderColumnPanel.Content\" uid=\"{32B7896D-2837-4591-84B2-C9052794CD48}\" />    <r id=\"{9B00BB85-3894-4FBD-8522-3C467FDEB050}\" par=\"Id=FilterControl&amp;IsVisible=0&amp;Facets=%7bBinding+DataSource.facets%7d\" ph=\"MainBorder.Content\" uid=\"{2D4C6069-ED07-4F9F-9F0E-94432ED7E05C}\" />    <r ds=\"{5FEFB941-F56B-46B9-B549-18EF2AA275ED}\" id=\"{913AB005-2527-4C2D-9827-FB3A8DFB135C}\" par=\"Click=javascript%3a+window.location.assign(%27%2fsitecore%2fclient%2fApplications%2fDialogs%2fUploadMediaDialog%3fref%3dlist%26ro%3d%7b0%7d%26fo%3d%7b1%7d%26showFullPath%3d%7b2%7d%27)%3b&amp;Id=UploadButton&amp;ButtonType=Primary&amp;Dimension=Large\" ph=\"DialogContent.Navigation\" uid=\"{8E7BAEEB-AF73-403F-BA7F-3E58ED535FD3}\" />    <r id=\"{C5D667DE-AA48-4072-872E-7C8BFFCE4D44}\" par=\"DefaultSelectedItemId=%257b65DFE8B2-ED7D-4BFE-B2F3-D3D9F6282E7C%257d&amp;IsRootHidden=1&amp;Id=Menu&amp;ItemsDataSource=%7b64DABB5A-C883-46A8-B8DB-B7250689121A%7d&amp;ExpandedItemIds=%7b637E46CD-3285-4840-AEB8-57EE9AD003C0%7d\" ph=\"DialogContent.Navigation\" uid=\"{DC28395B-36DE-4A0B-991B-A08A58B7D33D}\" />    <r id=\"{910155C7-3881-4A56-90FB-D126490EDE55}\" par=\"Id=MessageBar&amp;IsVisible=%7bBinding+DataSource.hasNoItems%7d&amp;Messages=%7b602E132C-A8E0-4E2F-9C91-1517666D2360%7d\" ph=\"MainBorder.Content\" uid=\"{29FDDC6E-315E-40E5-A16B-409949CE88F4}\" />    <r ds=\"{3D5FFD6D-EBA5-40EE-A90E-F53C75DFEAC3}\" id=\"{ACE0AFD6-3DE0-42CF-8E62-4E68CD810A8D}\" par=\"ScrollMoreData=next%3aDataSource&amp;Id=MediaResultsListControl&amp;Items=%7bBinding+DataSource.items%7d&amp;ViewMode=IconList&amp;IsEndlessScrollEnabled=1&amp;Height=500&amp;Behaviors=EndlessPageScroll\" ph=\"MainBorder.Content\" uid=\"{E2D4AA89-5E6B-4906-B074-287BB86274AA}\" />    <r id=\"{FE9723FC-56E4-4CA8-9C64-CB34F29462A5}\" par=\"Id=ProgressIndicator&amp;Delay=0&amp;IsBusy=%7bBinding+DataSource.IsBusy%7d&amp;AutoShow=0&amp;AutoShowTimeout=0&amp;TargetControl=MediaResultsListControl\" ph=\"MainBorder.Content\" uid=\"{A4EE282F-BE30-4CE7-B736-BF448C08FF7F}\" />    <r id=\"{F6C9F461-FCAF-47DC-AA01-C8C64C2EFFB8}\" par=\"Id=InfoBorderBox&amp;UsePadding=1\" ph=\"DialogContent.Main\" uid=\"{CC8A21FD-B581-42C3-810C-F83895167FE8}\" />    <r id=\"{F6C9F461-FCAF-47DC-AA01-C8C64C2EFFB8}\" par=\"Id=InfoBorder\" ph=\"InfoBorderBox.Content\" uid=\"{D37A8DD9-12C0-4381-B2E9-B3D9C5696510}\" />    <r id=\"{F6C9F461-FCAF-47DC-AA01-C8C64C2EFFB8}\" par=\"Id=PreviewBorder&amp;IsVisible=%7bBinding+MediaResultsListControl.HasSelectedItem%2c+Converter%3dNot%7d\" ph=\"InfoBorder.Content\" uid=\"{60B01849-E505-4072-8866-E67012757004}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=PreviewText\" ph=\"PreviewBorder.Content\" uid=\"{FEDA002C-CF3E-4B4C-9F64-0B47B360A418}\" ds=\"{5ABB1D2A-F153-40FE-8B96-29534A7B414C}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=InfoTitle&amp;IsVisible=%7bBinding+MediaResultsListControl.HasSelectedItem%7d&amp;TextType=LargeTitle\" ph=\"InfoBorder.Content\" uid=\"{6F1A14F1-DBA8-4A4F-A0C9-7A41227839E6}\" />    <r id=\"{F517C5E4-9A53-46C3-B922-5B44E6DAAA48}\" par=\"Id=InfoImage&amp;IsVisible=%7bBinding+MediaResultsListControl.HasSelectedItem%2c+DefaultValue%3dFalse%7d\" ph=\"InfoBorder.Content\" uid=\"{DD7A6455-F45D-4FD4-9AA5-05CCC70591CC}\" />    <r id=\"{F6C9F461-FCAF-47DC-AA01-C8C64C2EFFB8}\" par=\"Id=InfoNameRow&amp;IsVisible=%7bBinding+MediaResultsListControl.HasSelectedItem%2c+DefaultValue%3dFalse%7d&amp;UsePadding=0\" ph=\"InfoBorder.Content\" uid=\"{0C4B7EC4-3403-4352-A9DE-EFFB8C771599}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=InfoNameLabel&amp;TextType=Label&amp;Text=Name%3a\" ph=\"InfoNameRow.Content\" uid=\"{0AD34FED-934A-4678-8D3C-335A61344BB4}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"&amp;Id=InfoName&amp;TextType=Value\" ph=\"InfoNameRow.Content\" uid=\"{0AD34FED-934A-4678-8D3C-335A61344BB4}\" />    <r id=\"{F6C9F461-FCAF-47DC-AA01-C8C64C2EFFB8}\" par=\"Id=InfoTypeRow&amp;IsVisible=%7bBinding+MediaResultsListControl.HasSelectedItem%2c+DefaultValue%3dFalse%7d&amp;UsePadding=0\" ph=\"InfoBorder.Content\" uid=\"{0C4B7EC4-3403-4352-A9DE-EFFB8C771599}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=InfoTypeLabel&amp;TextType=Label&amp;Text=Type%3a\" ph=\"InfoTypeRow.Content\" uid=\"{4A158C4C-69C9-4ED0-B84C-A42B4905ED2B}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"&amp;Id=InfoType&amp;TextType=Value\" ph=\"InfoTypeRow.Content\" uid=\"{4A158C4C-69C9-4ED0-B84C-A42B4905ED2B}\" />    <r id=\"{F6C9F461-FCAF-47DC-AA01-C8C64C2EFFB8}\" par=\"Id=InfoDimensionRow&amp;IsVisible=%7bBinding+MediaResultsListControl.HasSelectedItem%2c+DefaultValue%3dFalse%7d&amp;UsePadding=0\" ph=\"InfoBorder.Content\" uid=\"{0C4B7EC4-3403-4352-A9DE-EFFB8C771599}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"&amp;Id=InfoDimensionLabel&amp;IsVisible=1&amp;TextType=Label&amp;Text=Dimensions%3a\" ph=\"InfoDimensionRow.Content\" uid=\"{E75DFFE7-3865-4DDA-AA3E-D48065031706}\" />    <r id=\"{7717EB6C-9F90-4C58-826D-5E87722A0318}\" par=\"Id=InfoDimension&amp;IsVisible=1&amp;TextType=Value\" ph=\"InfoDimensionRow.Content\" uid=\"{E75DFFE7-3865-4DDA-AA3E-D48065031706}\" />    <r id=\"{1169C5EF-E49C-4B59-848D-9C9204E40D12}\" par=\"RuleItemId=%7b60D765C3-D44B-41FE-BCD0-C9896E05E68B%7d&amp;Id=ListControlRule&amp;TargetControl=MediaResultsListControl&amp;Trigger=change%3aselectedItemId&amp;Field=Rule\" ph=\"Page.Body\" uid=\"{938F34BF-C26B-489A-8E0F-EC79401D77C4}\" />    <r id=\"{1169C5EF-E49C-4B59-848D-9C9204E40D12}\" par=\"RuleItemId=%7b8C8B1F19-B15A-459D-8584-EBE44F4A89B3%7d&amp;Id=FacetsRule&amp;TargetControl=DataSource&amp;Trigger=change%3afacets&amp;Field=Rule\" ph=\"Page.Body\" uid=\"{1519886A-1752-4361-A346-F2152B4ED19A}\" />    <r id=\"{1169C5EF-E49C-4B59-848D-9C9204E40D12}\" par=\"RuleItemId=%7b8C345C5C-E003-4BD1-806F-3D654087259C%7d&amp;Id=InsertButtonRule&amp;TargetControl=SelectMediaButton&amp;Trigger=click&amp;Field=Rule\" ph=\"Page.Body\" uid=\"{A739E6CD-0B38-457B-A448-6E22DA73D8AC}\" />    <r id=\"{1169C5EF-E49C-4B59-848D-9C9204E40D12}\" par=\"RuleItemId=%7bEAD81BDF-91D3-4027-A706-33DAD0167103%7d&amp;Id=CancelButtonRule&amp;TargetControl=CancelButton&amp;Trigger=click&amp;Field=Rule\" ph=\"Page.Body\" uid=\"{45F82880-AB69-4AAB-A1C5-D75DB4FF402F}\" />    <r id=\"{1169C5EF-E49C-4B59-848D-9C9204E40D12}\" par=\"RuleItemId=%7bF8BCD7F8-13E8-4795-96DA-EEE592CEFC58%7d&amp;Id=ItemsRule&amp;TargetControl=DataSource&amp;Trigger=itemsChanged&amp;Field=Rule\" ph=\"Page.Body\" uid=\"{19B56ED8-77EA-49F4-AAD4-F559A4CB75CE}\" />  </d></r>";

        var database = Factory.GetDatabase(databaseName);
        var item = database.GetItem(itemPath);

        Log.Audit($"Installing Sitecore.Support.96838", this);

        if (string.Equals(item[fieldName], fieldValue, StringComparison.Ordinal))
        {
          Log.Info($"Sitecore.Support.96838 already installed {item.Paths.FullPath}", this);
          return;
        }

        item.Editing.BeginEdit();
        item[fieldName] = fieldValue;
        item.Editing.EndEdit();

        Log.Info($"Sitecore.Support.96838 installed. Item {item.Paths.FullPath} updated in the {databaseName} database.", this);
      }
    }
  }
}